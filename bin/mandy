#!/usr/bin/env ruby

def absolute_path(path)
  path =~ /^\// ? path : File.join(Dir.pwd, path)
end

mode   = ARGV[0]
file   = absolute_path(ARGV[1])
input  = absolute_path(ARGV[2]) if ARGV[2]
output = absolute_path(ARGV[3]) if ARGV[3]

require file

case mode
  when 'local'
    `cat #{input} | bin/mandy map #{file} | sort | bin/mandy reduce #{file} >> #{output}`
  when 'remote'
    `$HADOOP_HOME/bin/hadoop jar $HADOOP_HOME/hadoop-streaming.jar \
                      -input "#{input}"  \
                      -mapper "bin/mandy map #{file}"  \
                      -reducer "bin/mandy map #{file}"  \
                      -file "#{file}"
                      -output "#{output}"`
  when 'map'
    Mandy::Job.default.run_map
  when  'reduce'
    Mandy::Job.default.run_reduce
end
